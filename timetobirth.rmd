---
title: "STA215"
author: "Sebastien DIAZ"
date: "13 mars 2016"
output: html_document
---

```{r}
library(survival)
```

## Chargement des données
```{r}
d2g<-read.csv("d2g.txt", header = TRUE, sep = " ",na.strings = "<NA>")
d2g[d2g$sperm == "NA",]$sperm=NA
d2g$sperm=as.numeric(d2g$sperm)
d2g[d2g$testo == "NA",]$testo=NA

d2g$testo=as.numeric(gsub("NA", "", d2g$testo))

```

## Description des données
Les données décrivent le délai de grosesse selon les covariables suivantes:

- d2g    : delai de grossesse en jours 
- indic  : 1 = grossesse , 0 = censure

- bmiF   : bmi de la femme
- bmiH   : bmi de l'homme 
- alcF   : nombre de boisson alcolisée par semaine chez la femme 
- alcH   : nombre de boisson alcolisée par semaine chez l'homme 
- fumF   : 1 =  fumeuse,  0=  pas fumeuse
- fumH   : 1 = fumeur,  0= pas fumeur
- ageF   : age en année
- ageH   : age en année 
- sperm  : spermatozoïdes en million 
- testo  : niveau de testosterone

##Sommaire statistique des variables
```{r}
nrow(d2g)
summary(d2g)
```

Le délai de grossesse (d2g) s'étale de 15 à 195 jours. Il y a 40% de censure (indic). Nous avons certainement à faire a une population plutot a risque de grossese prématuré. Le délai de grosses normal étant de 9 mois,plus de 260 jours.

Le bmi des femmes et des hommes contient une incohérence sur la valeur minimum -1111.11 qui est bien entendu impossible et doit représenté une donnée manquante.
```{r}
nrow(d2g[d2g$bmiF<0,])
nrow(d2g[d2g$bmiH<0,])
nrow(d2g[d2g$bmiH<0&d2g$bmiF<0,])
```
Seulement deux indivdus sont concernés pour le bmi des femmes et des hommes.
En les enlevement, le sommaire est:
```{r}
summary(d2g[d2g$bmiF>0,]$bmiF)
summary(d2g[d2g$bmiH>0,]$bmiH)
```
Le bmi des hommes dans l'échantillon est plus important aussi sur la valeur minimum, la médiane , la moyenne ou la valeur maximale.

Le nombre de boisson alcoolisé(alcF et alcH) est très largement supérieur pour les hommes. Il y a dans les deux sexes des quantités minimum à 0. Les hommes peuvent consommer jusqu'a 84 boissons par semaine ce qui est très important.

Il y a 29 % de fumeur femme(fumF) et 31 % d'hommes(fumH) dans cet échantillon.

L'age des hommes et des femmes est sensiblement comparable. L'age minimum est de 20 ans pour les femmes et 18 pour les hommes. L'age maximale est de 35 ans pour les femmes et 37 ans pour les hommes. La moyenne quant a elle est de 26 pour les femmes et 28 ans pour les hommes.

Les spermatozoide posséde pres de 113 values manquantes.  Evoluant de 1 à 156 millions de spermatozoides, il y a en moyenne 85 millions de spermatozoides.

Les taux de testoterones sont particulièrement mal renseigné avec près de 388 valeurs manquantes soit près de 92% de l'échantillon.

## Gestion des données manquantes
On change les deux individus ayants des données de bmi manquante par NA.
```{r}
d2g[d2g$bmiH<0,]$bmiH<-NA
d2g[d2g$bmiF<0,]$bmiF<-NA
```
On charge les libraries utiles par imputation multiple.
```{r}
library(mice)
library(lattice)
```
On lance l'algorithme d'imputation des données manquantes.
Pui son impute 
```{r}
imp1<-mice(d2g[,c(2,4,5,6,7,10,11,12)],m=1,seed=500)

densityplot(imp1)

```
Comme il n'y pas que deux données d'imputation de données pour les variables bmi, on ne visualisera pas leur distribution.

Au contraire du nombre de spermatozoide, ou les variables manquantes sont tres frequentes.
Lorsque l'on regarde la distribution des spermatozoide. Les nouvelles données ont une distribution proche des données originales.

Puis, on impute les données sur notre jeux original.
```{r}
comp<-complete(imp1, 1)
d2g$sperm<-comp$sperm
d2g$bmiH<-comp$bmiH
d2g$bmiF<-comp$bmiF
```

## Correlation des variables quantitatives

```{r}
cor(d2g[,c(2,4,5,6,7,10,11,12)])
```
Il n'y a aucune forte correlation entre nos variables. La corrélation la plus forte est sur le nombre de boisson alcoolisé par semaine entre les hommes et les femmes.

## Variables qualitatives

```{r}
table(d2g$fumF,d2g$fumH)
```
La proportion de non fumeur est plus importante.

## Analyse des fonctions de survie

On commence par decoupé nos variables quantitatives en variables qualitative de facon équitable en prenant les quantiles (<25%,25%-50%,50%-75% et >75%).

```{r}
d2g$bmiFQual <- cut(d2g$bmiF,breaks=quantile(d2g$bmiF),include.lowest=TRUE)
levels(d2g$bmiFQual)
d2g$bmiHQual <- cut(d2g$bmiH,breaks=quantile(d2g$bmiH),include.lowest=TRUE)
levels(d2g$bmiHQual)
d2g$alcFQual <- cut(d2g$alcF,breaks=unique(quantile(d2g$alcF)),include.lowest=TRUE)
levels(d2g$alcFQual)
d2g$alcHQual <- cut(d2g$alcH,breaks=quantile(d2g$alcH),include.lowest=TRUE)
levels(d2g$alcHQual)
d2g$ageFQual <- cut(d2g$ageF,breaks=quantile(d2g$ageF),include.lowest=TRUE)
levels(d2g$ageFQual)
d2g$ageHQual <- cut(d2g$ageH,breaks=quantile(d2g$ageH),include.lowest=TRUE)
levels(d2g$ageHQual)
d2g$spermQual <- cut(d2g$sperm,breaks=quantile(d2g$sperm),include.lowest=TRUE)
levels(d2g$spermQual)
```

```{r}
fit <- survfit(Surv(d2g, indic) ~ 1, data = d2g) 
plot(fit, lty = 2:3)

```
La courbe de survie decroit regulierement en fonction du nombre de jour. Notre fonction de survie s'arrete autour de 200 jours. Les données supérieures sont censurées.


```{r}
colList<-c("red","blue","green","black")
#bmiF
fit <- survfit(Surv(d2g, indic) ~ bmiFQual, data = d2g) 
plot(fit, lty = 2:3,col=colList) 
title("Fonction de survie - BMI Femme") 
legend(130, .97, c("(24.3,37.6]","(21.9,24.3]", "(20.3,21.9]","[15.2,20.3]"), lty = 2:3,col=1:length(d2g$bmiFQual)) 
plot(fit, lty = 2:3,col=colList,fun="cloglog") 
title("Risque cumulé - BMI Femme") 
legend(130, .97, c("(24.3,37.6]","(21.9,24.3]", "(20.3,21.9]","[15.2,20.3]"), lty = 2:3,col=1:length(d2g$bmiFQual)) 

```
Jusqu'a 100 jours et quelque soit l'indice de masse corporelle, il n'y a pas grande différence. Les courbes sont assez proche. Après 100 jours de grosses, les femmes, dont le BMI est plus important ont tendance à avoir  une survie plus longue. Au vu de la courbe des risque cumulé, on ne peut tenter un test du log rank pour voir si les courbes de survie sont identiques.

```{r}
#bmiH
fit <- survfit(Surv(d2g, indic) ~ bmiHQual, data = d2g) 
plot(fit, lty = 2:3,col=colList) 
title("Fonction de survie - BMI Homme") 
legend(130, .97, c("(25.9,38.6]", "(24.1,25.9]","(22.5,24.1]", "[18.2,22.5]"), lty = 2:3,col=1:length(d2g$bmiHQual))
plot(fit, lty = 2:3,col=colList,fun="cloglog") 
title("Risque cumulé - BMI Homme") 
legend(130, .97, c("(25.9,38.6]", "(24.1,25.9]","(22.5,24.1]", "[18.2,22.5]"), lty = 2:3,col=1:length(d2g$bmiHQual))


```
La fonction met en évidence que le l'indice de masse corporel moyen [22-24] chez l'homme a une survie légèrement plus forte. Les courbes restantes sont paralleles et ne presume pas d'une forte différence.
Les courbes de risque cumulés ne sont pas indiqué pour tester l'égalité des courbes de survie.



```{r}
#alcF
fit <- survfit(Surv(d2g, indic) ~ alcFQual, data = d2g) 
plot(fit, lty = 2:3,col=colList)
title("Fonction de survie - Alcool Femme") 
legend(130, .97, c("(6,39]",  "(2,6]",  "[0,2]"), lty = 2:3,col=colList)
plot(fit, lty = 2:3,col=colList,fun="cloglog") 
title("Risque cumulé - Alcool Femme") 
legend(130, .97, c("(6,39]",  "(2,6]",  "[0,2]"), lty = 2:3,col=colList)

```
On s'appercoit que les femmes ayant une alcoolemie tres faible, on une courbe se survie pendant la grosesse plus importante. Une l'acoolemie superieure a deux verres par semaine conduit à une coubre plus faible. La courbe de risaue cumulé fait apparaitre une non proportionnalité des courbes du nottament aux croisements entre les variables.



```{r}
#alcH
fit <- survfit(Surv(d2g, indic) ~ alcHQual, data = d2g) 
plot(fit, lty = 2:3,col=colList) 
title("Fonction de survie - Alcool Homme") 
legend(130, .97, c("(30.1,37.2]", "(27.9,30.1]","(26.2,27.9]", "[18.3,26.2]"), lty = 2:3,col=colList)
plot(fit, lty = 2:3,col=colList,fun="cloglog") 
title("Risque cumulé - Alcool Homme") 
legend(130, .97, c("(30.1,37.2]", "(27.9,30.1]","(26.2,27.9]", "[18.3,26.2]"), lty = 2:3,col=colList)

```
Les courbes de survie sur l'alcoolemie des hommes sont tres proches. Le test du log rank n'est pas approprié au vue de des risques cumulés dont les courbes s'entrecroisent. On ne peut conclure à l'égalité des courbes de survie.

```{r}
#ageF
fit <- survfit(Surv(d2g, indic) ~ ageFQual, data = d2g) 
plot(fit, lty = 2:3,col=colList) 
title("Fonction de survie - Age Femme") 
legend(130, .97, c("(27.9,35.2]" ,"(25.9,27.9]","(24.1,25.9]"  ,"[19.8,24.1]"), lty = 2:3,col=1:length(d2g$ageFQual))
plot(fit, lty = 2:3,col=colList,fun="cloglog") 
title("Risque cumulé - Age Femme") 
legend(130, .97, c("(27.9,35.2]" ,"(25.9,27.9]","(24.1,25.9]"  ,"[19.8,24.1]"), lty = 2:3,col=1:length(d2g$ageFQual))

survdiff(Surv(d2g, indic) ~ ageFQual, data = d2g)
```
La fonction de survie des femmes d'age de 20 à 24 ans est legerement plus faible comparer aux ages superieur. Les courbes de risque cumulé et de fonction de survie sont paralleles et le test du log rank confirme cette hypothese graphique.


```{r}
#ageH
fit <- survfit(Surv(d2g, indic) ~ ageHQual, data = d2g) 
plot(fit, lty = 2:3,col=colList) 
title("Fonction de survie - Age Homme") 
legend(130, .97, c( "(30.1,37.2]" ,"(27.9,30.1]","(26.2,27.9]", "[18.3,26.2]"), lty = 2:3,col=1:length(d2g$ageHQual))
plot(fit, lty = 2:3,col=colList,fun="cloglog") 
title("Risque cumulé - Age Homme") 
legend(130, .97, c( "(30.1,37.2]" ,"(27.9,30.1]","(26.2,27.9]", "[18.3,26.2]"), lty = 2:3,col=1:length(d2g$ageHQual))
```
Les courbes de survie et de risque cumulé de l'age des hommes sont très proches et se croisent à de nombreux endroits. Le test du log rank n'étant pas forcement le plus indiqué dans ce cas de non respect de proportionnalité des risques, nous ne pouvons conclure à l'égalité des courbes de survie selon les ages. 

```{r}
#fumF
fit <- survfit(Surv(d2g, indic) ~ fumF, data = d2g) 
plot(fit, lty = 2:3,col=colList) 
title("Fonction de survie - Fumeur Femme") 
legend(130, .97, c("Non fumeuse","Fumeuse"), lty = 2:3,col=1:length(d2g$fumF))
plot(fit, lty = 2:3,col=colList,fun="cloglog") 
title("Risque cumulé - Fumeur Femme") 
legend(130, .97, c("Non fumeuse","Fumeuse"), lty = 2:3,col=1:length(d2g$fumF))
survdiff(Surv(d2g, indic) ~ fumF, data = d2g)

```
Les femmes fumeuse ont un survie plus faible que les non fumeuses. Les risque sont presque paralleles avec quelques entrecroisements. Le test du log rank met en évidence que les courbes de survie entre les femmes fumeuses et non fumeuses sont differentes.


```{r}
#fumH
fit <- survfit(Surv(d2g, indic) ~ fumH, data = d2g) 
plot(fit, lty = 2:3,col=colList) 
title("Fonction de survie - Fumeur Homme") 
legend(130, .97, c("Non fumeur","Fumeur"), lty = 2:3,col=1:length(d2g$fumH))
plot(fit, lty = 2:3,col=colList,fun="cloglog") 
title("Risque cumulé - Fumeur Homme") 
legend(130, .97, c("Non fumeur","Fumeur"), lty = 2:3,col=1:length(d2g$fumH))
survdiff(Surv(d2g, indic) ~ fumH, data = d2g)

```
Comme pour les femmes les hommes fumeurs ont une courbe de survie légèremment plus faible. La courbe de risque paressant parrallele, on utilise le test du log rank qui nous permet de conclure à l'égalité des courbes de survie. 


```{r}
#Sperm
fit <- survfit(Surv(d2g, indic) ~ spermQual, data = d2g) 
plot(fit, lty = 2:3,col=colList) 
title("Fonction de survie - Sperm")
legend(130, .97, c("(119,156]" , "(88,119]" ,"(51.5,88]" , "[1,51.5]"), lty = 2:3,col=1:length(d2g$spermQual))
plot(fit, lty = 2:3,col=colList,fun="cloglog")
title("Risque cumulé - Sperm")
legend(130, .97, c("(119,156]" , "(88,119]" ,"(51.5,88]" , "[1,51.5]"), lty = 2:3,col=1:length(d2g$spermQual))
```
Les courbes de survie correspondant aux millions de spermes chez les hommes sont tres proche. Les fonctions de risque cumulées sont proche mais s'entrecroisent et ne permettent de valider une égalité des fonctions de survies. 



legend(100, .8, c("Maintained", "Nonmaintained","toto"), lty = 2:3) 
plot(fit, conf.int=T, lty=3:2, lwd=1,  cex=2, log=T,
     xlab="Délai de grosesse (jours)", ylab="Survie")
par(mfrow=c(2,2))
plot(wt,mpg, main="Scatterplot of wt vs. mpg")
plot(wt,disp, main="Scatterplot of wt vs disp")
```
This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
summary(cars)
```

You can also embed plots, for example:

```{r, echo=FALSE}
plot(cars)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
